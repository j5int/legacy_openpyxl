#!/bin/bash
# this is a git tree-filter intented to be run with git filter-branch --tree-filter "bash /path/to/rename-to-legacy_openpyxl"
if [ -d openpyxl ]; then
    v1=true
    if [ -f openpyxl/.constants.json ] || [ -f openpyxl/_constants.py ]; then
        v1=
    fi
    grep -h "__major__ = 2" openpyxl/__init__.py >/dev/null && v1=
    grep -h "__version__ = .2" openpyxl/__init__.py >/dev/null && v1=
    if [ "$v1" ] ; then
        mv openpyxl legacy_openpyxl
        cp "$0" ./rename-to-legacy_openpyxl
        sed -i "s#openpyxl#legacy_openpyxl#" .hgignore MANIFEST.in pytest.ini setup.py shippable.yml tox.ini 2>/dev/null
        grep -lr "import openpyxl" legacy_openpyxl/ doc/conf.py 2>/dev/null | xargs -n1 sed -i "s#\<openpyxl\>#legacy_openpyxl#g"
        echo "legacy_openpyxl is a renamed version of the openpyxl library version 1, to allow side-by-side installation with newer versions.\nNot all documentation etc has been adapted.\nThe entire repository was generated by converting to git and using a git filter-branch command, found in ./rename-to-legacy_openpyxl\n" > README.rst
        find legacy_openpyxl/ doc/ -name "*.py" | xargs sed -i "s#\(^ *\)from  *openpyxl\([. ]\)#\1from legacy_openpyxl\2#
                s#\(:rtype:.*\|:func:.*\)openpyxl#\1legacy_openpyxl#
                s#\"\"\"openpyxl#\"\"\"legacy_openpyxl#
                s#instances of openpyxl#instances of legacy_openpyxl#"
        find doc/ -name "*.rst" | grep -v changes.rst | xargs sed -i "s#>>> import openpyxl#>>> import legacy_openpyxl#
                s#>>> from openpyxl[.]#>>> from legacy_openpyxl[.]#
                s#module:: openpyxl\$#module:: legacy_openpyxl#
                s#\`openpyxl\`#\`legacy_openpyxl\`#
                s#\`openpyxl[.]#\`legacy_openpyxl[.]#"
    fi
fi

